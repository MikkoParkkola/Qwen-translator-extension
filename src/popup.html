<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <style>
    :root {
      --bg-color: #f8f9fa;
      --text-color: #212529;
      --input-bg: #fff;
      --input-border: #ced4da;
      --input-focus-border: #86b7fe;
      --primary-color: #0d6efd;
      --primary-hover-color: #0b5ed7;
      --secondary-bg: #e9ecef;
      --secondary-hover-bg: #dee2e6;
      --bar-bg: #e9ecef;
      --green: #198754;
      --yellow: #ffc107;
      --red: #dc3545;
      --body-width: 420px;
    }

    @media (prefers-color-scheme: dark) {
      :root {
        --bg-color: #212529;
        --text-color: #f8f9fa;
        --input-bg: #343a40;
        --input-border: #495057;
        --secondary-bg: #343a40;
        --secondary-hover-bg: #495057;
        --bar-bg: #495057;
      }
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      width: var(--body-width);
      padding: 1rem;
      margin: 0;
      background-color: var(--bg-color);
      color: var(--text-color);
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      max-height: 580px;
      overflow-y: auto;
    }

    /* View switching logic */
    .view-container > .setup-view,
    .view-container > .main-view {
      display: none;
    }
    .view-container.show-setup .setup-view {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }
    .view-container.show-main .main-view {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    /* ... (rest of the styles from previous version) ... */
    .main-actions { display: flex; gap: 0.5rem; align-items: center; }
    #translate { flex-grow: 1; }
    .auto-translate-toggle { display: flex; align-items: center; gap: 0.5rem; font-size: 0.875rem; }
    .force-toggle { display: flex; align-items: center; gap: 0.5rem; font-size: 0.875rem; }
    .switch { position: relative; display: inline-block; width: 34px; height: 20px; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--secondary-bg); transition: .4s; border-radius: 20px; }
    .slider:before { position: absolute; content: ""; height: 14px; width: 14px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
    input:checked + .slider { background-color: var(--primary-color); }
    input:checked + .slider:before { transform: translateX(14px); }
    .usage-section { font-size: 0.75rem; display: grid; grid-template-columns: 1fr 1fr; gap: 0.25rem 1rem; padding: 0.5rem; background: var(--secondary-bg); border-radius: 8px; }
    .usage-item { display: flex; flex-direction: column; }
    .bar { height: 6px; background: var(--bar-bg); border-radius: 3px; overflow: hidden; margin-top: 2px; }
    .bar > div { height: 100%; width: 0%; transition: width 0.2s ease-in-out, background-color 0.2s ease-in-out; }
    .form-group { display: flex; flex-direction: column; gap: 0.5rem; }
    label { font-size: 0.875rem; }
    input[type=text], input[type=number], select { width: 100%; box-sizing: border-box; padding: 0.5rem 0.75rem; border: 1px solid var(--input-border); border-radius: 6px; background-color: var(--input-bg); color: var(--text-color); font-size: 1rem; }
    input:focus, select:focus { outline: none; border-color: var(--input-focus-border); box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25); }
    button { padding: 0.6rem 1rem; border: none; border-radius: 6px; background-color: var(--primary-color); color: #fff; font-weight: 600; cursor: pointer; transition: background-color 0.15s ease-in-out; }
    button:hover { background-color: var(--primary-hover-color); }
    button#test { background-color: var(--secondary-bg); color: var(--text-color); }
    button#test:hover { background-color: var(--secondary-hover-bg); }
    #status { font-size: 0.875rem; min-height: 40px; max-height: 150px; overflow-y: auto; border: 1px solid var(--input-border); padding: 0.5rem; background-color: var(--input-bg); border-radius: 6px; white-space: pre-wrap; }
    #version { font-size: 0.75rem; text-align: center; opacity: 0.7; }
    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; }
    summary { cursor: pointer; font-weight: 600; }
    .cost-section { grid-template-columns: 1fr 1fr 1fr; }
  </style>
</head>
<body>
  <div id="viewContainer" class="view-container">
    <!-- ===== SETUP VIEW ===== -->
    <div class="setup-view">
      <h3>Initial Setup</h3>
      <p>Please configure the essential settings to start using the extension.</p>
      <div class="form-group">
        <label for="setup-apiKey">API Key</label>
        <input type="text" id="setup-apiKey" placeholder="Enter your API key" title="DashScope API key (required)">

        <label for="setup-apiEndpoint">API Endpoint</label>
        <input type="text" id="setup-apiEndpoint" placeholder="e.g., https://dashscope-intl.aliyuncs.com/api/v1" title="DashScope API endpoint">

        <label for="setup-model">Model</label>
        <select id="setup-model" title="Select translation model. Turbo is cheaper; Plus is higher quality.">
          <option value="qwen-mt-turbo">qwen-mt-turbo</option>
          <option value="qwen-mt-plus">qwen-mt-plus</option>
        </select>
      </div>
      <p>Your settings are saved automatically.</p>
    </div>

    <!-- ===== MAIN VIEW ===== -->
    <div class="main-view">
      <div class="main-actions">
        <button id="translate" title="Translate the current tab">Translate Page</button>
        <div class="auto-translate-toggle">
          <label class="switch">
            <input type="checkbox" id="auto">
            <span class="slider"></span>
          </label>
          <span title="Automatically translate supported pages as they load. You can still click Translate Page to force refresh.">Auto</span>
        </div>
      </div>
      <div class="main-actions">
        <button id="clearCache" title="Remove saved translations">Clear Cache</button>
        <button id="clearDomain" title="Clear cache for current domain">Clear Domain</button>
        <button id="clearPair" title="Clear cache for selected languages">Clear Pair</button>
        <span id="cacheSize" style="font-size:0.875rem"></span>
        <span id="hitRate" style="font-size:0.875rem"></span>
        <span id="compressionErrors" style="font-size:0.875rem"></span>
        <label class="force-toggle"><input type="checkbox" id="force"> Force</label>
      </div>
      <div id="domainCounts" style="font-size:0.75rem"></div>

      <div class="usage-section">
        <div class="usage-item">
          <span>Requests: <span id="reqCount">0/0</span></span>
          <div class="bar"><div id="reqBar"></div></div>
        </div>
        <div class="usage-item">
          <span>Tokens: <span id="tokenCount">0/0</span></span>
          <div class="bar"><div id="tokenBar"></div></div>
        </div>
        <div class="usage-item">
          <span>Turbo: <span id="turboReq">0/0</span></span>
          <div class="bar"><div id="turboReqBar"></div></div>
        </div>
        <div class="usage-item">
          <span>Plus: <span id="plusReq">0/0</span></span>
          <div class="bar"><div id="plusReqBar"></div></div>
        </div>
        <div class="usage-item">Total Requests: <span id="totalReq">0</span></div>
        <div class="usage-item">Total Tokens: <span id="totalTok">0</span></div>
        <div class="usage-item">Queue: <span id="queueLen">0</span></div>
        <div class="usage-item">Failed Requests: <span id="failedReq">0</span></div>
        <div class="usage-item">Failed Tokens: <span id="failedTok">0</span></div>
        <div class="usage-item">
          Remaining Requests: <span id="reqRemaining">0</span>
          <div class="bar"><div id="reqRemainingBar"></div></div>
        </div>
        <div class="usage-item">
          Remaining Tokens: <span id="tokenRemaining">0</span>
          <div class="bar"><div id="tokenRemainingBar"></div></div>
        </div>
        <div class="usage-item">Provider Error: <span id="providerError"></span></div>
      </div>

      <div class="usage-section cost-section" id="costSection"></div>
      <button id="toggleCalendar">Show daily costs</button>
      <div id="costCalendar" style="display:none;font-size:0.75rem"></div>

      <div class="grid-2">
        <div>
          <label for="source">Source Language</label>
          <select id="source" title="Language to translate from. Use 'Auto-detect' for convenience and mixed-language pages."></select>
        </div>
        <div>
          <label for="target">Target Language</label>
          <select id="target" title="Language to translate into (your reading language)."></select>
        </div>
      </div>

      <details>
        <summary>Getting Started</summary>
        <ol>
          <li>Open Advanced Settings and choose a Provider preset, then paste your API key.</li>
          <li>Set Target Language (your reading language). Leave Source as Auto‑detect.</li>
          <li>Optional: set Detector to Google and add a Detection API key for better auto‑detect.</li>
          <li>Click “Translate Page” or enable Auto to translate pages as they load.</li>
        </ol>
        <p>Where to get API keys:</p>
        <ul>
          <li>DashScope (Qwen): <a href="https://dashscope.console.aliyun.com/" target="_blank" rel="noopener">Console</a></li>
          <li>OpenAI: <a href="https://platform.openai.com/api-keys" target="_blank" rel="noopener">API keys</a></li>
          <li>DeepL: <a href="https://www.deepl.com/pro-api" target="_blank" rel="noopener">Pro API</a></li>
          <li>Google (Detection): <a href="https://cloud.google.com/translate/docs/setup" target="_blank" rel="noopener">Setup</a></li>
        </ul>
      </details>

      <details>
        <summary>Advanced Settings</summary>
        <div class="form-group" style="padding-top: 0.75rem">
          <label for="apiKey">API Key</label>
<<<<<<< HEAD
          <input type="text" id="apiKey" placeholder="Enter your API key"
                 title="Your provider API key. Stored only in browser storage and used by the background. Never injected into pages.">

          <label for="apiEndpoint">API Endpoint</label>
          <input type="text" id="apiEndpoint" placeholder="e.g., https://dashscope-intl.aliyuncs.com/api/v1"
                 title="Base URL for your provider API (https://.../). A trailing slash is added automatically if omitted.">

          <label for="model">Model</label>
          <input type="text" id="model" placeholder="e.g., qwen-mt-turbo"
                 title="Provider model identifier (e.g., qwen-mt-turbo, gpt-4o-mini).">

          <label for="providerPreset">Provider preset</label>
          <select id="providerPreset" title="Pick a preset to auto‑fill endpoint and a typical model. Paste your API key separately.">
            <option value="">— Choose a provider —</option>
            <option value="dashscope">DashScope (Qwen)</option>
            <option value="openai">OpenAI</option>
            <option value="deepl">DeepL</option>
          </select>

          <label for="detector">Detector</label>
          <select id="detector" title="How to detect the source language when Source is auto. Local is private and free. Google requires a Detection API key.">
            <option value="local">Local (on-device)</option>
            <option value="google">Google (Cloud)</option>
          </select>

          <label for="detectApiKey">Detection API Key (Google)</label>
          <input type="text" id="detectApiKey" placeholder="Only needed for Google detector"
                 title="Google Cloud API key used only for language detection. Create a key and enable the Cloud Translation API.">
=======
          <input type="text" id="apiKey" placeholder="Enter your API key" title="DashScope API key (required)">

          <label for="apiEndpoint">API Endpoint</label>
          <input type="text" id="apiEndpoint" placeholder="e.g., https://dashscope-intl.aliyuncs.com/api/v1" title="DashScope API endpoint">

          <label for="model">Model</label>
          <select id="model" title="Translation model. Turbo is default; Plus offers higher quality at higher cost.">
            <option value="qwen-mt-turbo">qwen-mt-turbo</option>
            <option value="qwen-mt-plus">qwen-mt-plus</option>
          </select>

          <label for="failoverStrategy">Failover strategy</label>
          <select id="failoverStrategy" title="Model failover behaviour when multiple models are available">
            <option value="balanced">balanced</option>
            <option value="max-saving">max saving</option>
            <option value="max-speed">max speed</option>
          </select>

          <label for="provider">Provider</label>
          <select id="provider" title="Select translation provider"></select>

          <label for="providerOrder">Provider order</label>
          <input type="text" id="providerOrder" placeholder="qwen" title="Comma-separated provider order for automatic switching">

          <div class="grid-2">
            <div>
              <label for="requestThreshold">Request threshold</label>
              <input type="number" id="requestThreshold" title="Switch provider when remaining requests fall below this number">
            </div>
            <div>
              <label for="tokenThreshold">Token threshold</label>
              <input type="number" id="tokenThreshold" title="Switch provider when remaining tokens fall below this number">
            </div>
          </div>
>>>>>>> d85ab24219afb7ff5c24d5c2a917603994573a7f

          <div class="grid-2">
            <div>
              <label for="requestLimit">Requests/min</label>
<<<<<<< HEAD
              <input type="number" id="requestLimit" title="Maximum requests per minute. The extension throttles to stay under limits.">
            </div>
            <div>
              <label for="tokenLimit">Tokens/min</label>
              <input type="number" id="tokenLimit" title="Maximum tokens per minute. Adjust to match your provider quota.">
=======
              <input type="number" id="requestLimit" title="Maximum requests per minute. Leave empty to use automatic limit.">
            </div>
            <div>
              <label for="tokenLimit">Tokens/min</label>
              <input type="number" id="tokenLimit" title="Maximum combined input+output tokens per minute. Leave empty for automatic limit.">
>>>>>>> d85ab24219afb7ff5c24d5c2a917603994573a7f
            </div>
          </div>

          <label for="tokenBudget">Token budget</label>
<<<<<<< HEAD
          <input type="number" id="tokenBudget" placeholder="auto"
                 title="Max tokens per batch request. Leave blank for auto‑calibration.">
=======
          <input type="number" id="tokenBudget" placeholder="auto" title="Optional hard cap for total tokens used in this session.">

          <label><input type="checkbox" id="smartThrottle" checked title="Enable intelligent adaptive throttling"> Intelligent throttling</label>

          <div class="grid-2">
            <div>
              <label for="tokensPerReq" title="Target tokens per request when intelligent throttling is off">Tokens/request</label>
              <input type="number" id="tokensPerReq" disabled title="Desired tokens per request when manual throttling is enabled">
            </div>
            <div>
              <label for="retryDelay" title="Base retry delay in seconds when a rate limit is hit">Retry delay (s)</label>
              <input type="number" id="retryDelay" disabled title="Seconds to wait before first retry after a rate limit error">
            </div>
          </div>
>>>>>>> d85ab24219afb7ff5c24d5c2a917603994573a7f

          <label title="Enable detailed logs for troubleshooting in DevTools."><input type="checkbox" id="debug"> Debug logging</label>
        </div>
      </details>

      <button id="test">Test Settings</button>
      <progress id="progress" value="0" max="1" style="width:100%;display:none"></progress>
      <div id="status"></div>
      <div id="version"></div>
    </div>
  </div>

  <script src="throttle.js"></script>
<<<<<<< HEAD
  <script src="lib/messaging.js"></script>
=======
  <script src="lz-string.min.js"></script>
  <script src="cache.js"></script>
  <script src="providers/index.js"></script>
  <script src="providers/qwen.js"></script>
  <script src="providers/google.js"></script>
  <script src="providers/deepl.js"></script>
>>>>>>> d85ab24219afb7ff5c24d5c2a917603994573a7f
  <script src="translator.js"></script>
  <script src="config.js"></script>
  <script src="languages.js"></script>
  <script src="usageColor.js"></script>
  <script src="providerConfig.js"></script>
  <script src="popup/dom.js"></script>
  <script src="popup.js"></script>
</body>
</html>
