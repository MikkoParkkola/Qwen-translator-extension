<!DOCTYPE html>
<html data-qwen-theme="cyberpunk">
<head>
  <meta charset="utf-8">
  <link rel="stylesheet" href="styles/cyberpunk.css">
  <style>
    :root {
      --bg-color: var(--qwen-bg, #0a0c14);
      --text-color: var(--qwen-text, #e6f7ff);
      --input-bg: rgba(0, 0, 0, 0.2);
      --input-border: var(--qwen-border, #00e5ff);
      --input-focus-border: var(--qwen-neon-1, #00e5ff);
      --primary-color: var(--qwen-neon-1, #00e5ff);
      --primary-hover-color: var(--qwen-neon-2, #ff00e5);
      --secondary-bg: rgba(0, 0, 0, 0.35);
      --secondary-hover-bg: rgba(0, 0, 0, 0.55);
      --bar-bg: rgba(0, 0, 0, 0.3);
      --green: var(--qwen-neon-1, #00e5ff);
      --yellow: var(--qwen-neon-2, #ff00e5);
      --red: var(--qwen-error, #ff3b81);
      --body-width: 380px;
    }

    html {
      height: 100%;
      background: var(--bg-color) url('styles/popup-bg.svg') center/cover no-repeat;
      background-attachment: local;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      width: var(--body-width);
      padding: 1rem;
      margin: 0;
      background: transparent;
      color: var(--text-color);
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      min-height: 100%;
      overflow-y: auto;
      position: relative;
    }

    body::after {
      content: "";
      position: sticky;
      bottom: 0;
      left: 0;
      right: 0;
      height: 2rem;
      pointer-events: none;
      background: linear-gradient(to bottom, transparent, var(--bg-color));
    }

    /* View switching logic */
    .view-container > .setup-view,
    .view-container > .main-view {
      display: none;
    }
    .view-container.show-setup .setup-view {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }
    .view-container.show-main .main-view {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    /* ... (rest of the styles from previous version) ... */
    .main-actions { display: flex; gap: 0.5rem; align-items: center; }
    #translate { flex-grow: 1; }
    .auto-translate-toggle { display: flex; align-items: center; gap: 0.5rem; font-size: 0.875rem; }
    .switch { position: relative; display: inline-block; width: 34px; height: 20px; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--secondary-bg); transition: .4s; border-radius: 20px; }
    .slider:before { position: absolute; content: ""; height: 14px; width: 14px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
    input:checked + .slider { background-color: var(--primary-color); }
    input:checked + .slider:before { transform: translateX(14px); }
    .usage-section { font-size: 0.75rem; display: grid; grid-template-columns: 1fr 1fr; gap: 0.25rem 1rem; padding: 0.5rem; background: var(--secondary-bg); border-radius: 8px; }
    .usage-item { display: flex; flex-direction: column; }
    .bar { height: 6px; background: var(--bar-bg); border-radius: 3px; overflow: hidden; margin-top: 2px; }
      .bar > div { height: 100%; width: 0%; transition: width 0.2s ease-in-out, background-color 0.2s ease-in-out; }
    .form-group { display: flex; flex-direction: column; gap: 0.5rem; }
    .slider-group { display: flex; align-items: center; gap: 0.5rem; }
    .slider-group span { font-size: 0.75rem; }
    label { font-size: 0.875rem; }
    .help { font-size: 0.75rem; opacity: 0.8; }
    .view-options { display: flex; align-items: center; gap: 0.5rem; font-size: 0.875rem; }
    .view-options label { display: flex; align-items: center; gap: 0.25rem; }
    #status { font-size: 0.875rem; min-height: 40px; max-height: 150px; overflow-y: auto; border: 1px solid var(--input-border); padding: 0.5rem; background-color: var(--input-bg); border-radius: 6px; white-space: pre-wrap; }
    #version { font-size: 0.75rem; text-align: center; opacity: 0.7; }
    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; }
    .grid-2 > * { min-width: 0; }
    summary { cursor: pointer; font-weight: 600; }
    #usageDetails { padding: 0.25rem 0.5rem; background: var(--secondary-bg); border-radius: 8px; }
      #usageDetails summary { list-style: none; }
      #usageDetails[open] .usage-section { animation: fadeIn 0.3s ease-in; }
      #providerUsage { display: contents; }
      @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-4px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body class="qwen-bg-animated">
  <div id="viewContainer" class="view-container">
    <!-- ===== SETUP VIEW ===== -->
    <div class="setup-view">
      <h3>Initial Setup</h3>
      <p>Please configure the essential settings to start using the extension.</p>
      <div id="benchmarkRec" class="help"></div>
      <div class="form-group">
        <label for="setup-apiKey">API Key</label>
        <input type="text" id="setup-apiKey" placeholder="Enter your API key">

        <label for="setup-apiEndpoint">API Endpoint</label>
        <input type="text" id="setup-apiEndpoint" placeholder="e.g., https://dashscope-intl.aliyuncs.com/api/v1">

        <label for="setup-model">Model</label>
        <input type="text" id="setup-model" placeholder="e.g., qwen-mt-turbo">
      </div>
      <p>Your settings are saved automatically.</p>
    </div>

    <!-- ===== MAIN VIEW ===== -->
    <div class="main-view">
      <div class="main-actions">
        <button id="translate" class="primary-glow btn-frame" title="Translate the current tab">Translate Page</button>
        <div class="auto-translate-toggle">
          <label class="switch">
            <input type="checkbox" id="auto">
            <span class="slider"></span>
          </label>
          <span title="Automatically translate supported pages as they load. You can still click Translate Page to force refresh.">Auto</span>
        </div>
      </div>

      <div class="view-options">
        <label title="Compact layout"><input type="checkbox" id="compactMode"> Compact</label>
        <label title="Light theme"><input type="checkbox" id="lightMode"> Light</label>
      </div>

      <details open id="usageDetails" class="panel-frame">
        <summary>Usage</summary>
        <div class="usage-section">
          <div class="usage-item">
            <span>Requests: <span id="reqCount">0/0</span></span>
            <div class="bar"><div id="reqBar"></div></div>
          </div>
          <div class="usage-item">
            <span>Tokens: <span id="tokenCount">0/0</span></span>
            <div class="bar"><div id="tokenBar"></div></div>
          </div>
          <div class="usage-item">Total Requests: <span id="totalReq">0</span></div>
          <div class="usage-item">Total Tokens: <span id="totalTok">0</span></div>
          <div class="usage-item">Queue: <span id="queueLen">0</span></div>
          <div id="providerUsage"></div>
        </div>
        <div id="costSection"></div>
      </details>

    <details id="statsDetails" open class="panel-frame">
      <summary>Stats</summary>
      <div class="usage-section">
        <div class="usage-item">Total Requests: <span id="statsRequests">0</span></div>
        <div class="usage-item">Total Tokens: <span id="statsTokens">0</span></div>
        <div class="usage-item">Avg Latency: <span id="statsLatency">0</span> ms</div>
      </div>
    </details>
    <a href="qa/usage.html" target="_blank" rel="noopener">Usage</a>

    <div class="grid-2">
      <div>
        <label for="source">Source Language</label>
        <select id="source" title="Language to translate from. Use 'Auto-detect' for convenience and mixed-language pages."></select>
        </div>
        <div>
          <label for="target">Target Language</label>
          <select id="target" title="Language to translate into (your reading language)."></select>
        </div>
      </div>

      <details class="panel-frame">
        <summary>Getting Started</summary>
        <ol>
          <li>Open Advanced Settings and choose a Provider preset, then paste your API key.</li>
          <li>Set Target Language (your reading language). Leave Source as Auto‑detect.</li>
          <li>Optional: set Detector to Google and add a Detection API key for better auto‑detect.</li>
          <li>Click “Translate Page” or enable Auto to translate pages as they load.</li>
        </ol>
        <p>Where to get API keys:</p>
        <ul>
          <li>DashScope (Qwen): <a href="https://dashscope.console.aliyun.com/" target="_blank" rel="noopener">Console</a></li>
          <li>OpenAI: <a href="https://platform.openai.com/api-keys" target="_blank" rel="noopener">API keys</a></li>
          <li>DeepL: <a href="https://www.deepl.com/pro-api" target="_blank" rel="noopener">Pro API</a></li>
          <li>Google (Detection): <a href="https://cloud.google.com/translate/docs/setup" target="_blank" rel="noopener">Setup</a></li>
        </ul>
      </details>

      <details id="providerSection" class="panel-frame">
        <summary>Provider</summary>
        <div class="form-group" style="padding-top: 0.75rem">
          <label for="apiKey">API Key</label>
          <input type="text" id="apiKey" placeholder="Enter your API key"
                 title="Your provider API key. Stored only in browser storage and used by the background. Never injected into pages.">
          <small class="help">Authenticates requests. Required for translation.</small>

          <label for="apiEndpoint">API Endpoint</label>
          <input type="text" id="apiEndpoint" placeholder="e.g., https://dashscope-intl.aliyuncs.com/api/v1"
                 title="Base URL for your provider API (https://.../). A trailing slash is added automatically if omitted.">
          <small class="help">Base URL for API calls, typically ending with /api/v1.</small>

          <label for="model">Model</label>
          <input type="text" id="model" placeholder="e.g., qwen-mt-turbo"
                 title="Provider model identifier (e.g., qwen-mt-turbo, gpt-4o-mini).">
          <small class="help">Translation model name. Higher-tier models cost more.</small>

          <label for="providerPreset">Provider preset</label>
          <select id="providerPreset" title="Pick a preset to auto‑fill endpoint and a typical model. Paste your API key separately.">
            <option value="">— Choose a provider —</option>
            <option value="dashscope">DashScope (Qwen)</option>
            <option value="openai">OpenAI</option>
            <option value="openrouter">OpenRouter</option>
            <option value="deepl">DeepL</option>
            <option value="macos">macOS</option>
            <option value="ollama">Ollama</option>
          </select>
          <small class="help">Auto-fills endpoint and model; still paste your own key.</small>
        </div>
      </details>

      <details id="detectionSection" class="panel-frame">
        <summary>Detection</summary>
        <div class="form-group" style="padding-top: 0.75rem">
          <label for="detector">Detector</label>
          <select id="detector" title="How to detect the source language when Source is auto. Local is private and free. Google requires a Detection API key.">
            <option value="local">Local (on-device)</option>
            <option value="google">Google (Cloud)</option>
          </select>
          <small class="help">Local is free; Google improves accuracy but needs a key.</small>

          <label for="detectApiKey">Detection API Key (Google)</label>
          <input type="text" id="detectApiKey" placeholder="Only needed for Google detector"
                 title="Google Cloud API key used only for language detection. Create a key and enable the Cloud Translation API.">
          <small class="help">Required only when using Google detector.</small>

          <label for="sensitivity">Detection sensitivity</label>
          <div class="slider-group">
            <span>Low</span>
            <input type="range" id="sensitivity" min="0" max="1" step="0.1"
                   title="Minimum confidence required from language detector.">
            <span>High</span>
          </div>
          <small class="help">Minimum confidence required from language detector.</small>
        </div>
      </details>

      <details id="rateSection" class="panel-frame">
        <summary>Rate Limits</summary>
        <div class="form-group" style="padding-top: 0.75rem">
          <div class="grid-2">
            <div>
              <label for="requestLimit">Requests/min</label>
              <input type="number" id="requestLimit" title="Maximum requests per minute. The extension throttles to stay under limits.">
              <small class="help">Throttle requests per minute; 60 typical.</small>
            </div>
            <div>
              <label for="tokenLimit">Tokens/min</label>
              <input type="number" id="tokenLimit" title="Maximum tokens per minute. Adjust to match your provider quota.">
              <small class="help">Match provider quota, e.g., 100000.</small>
            </div>
          </div>

          <label for="tokenBudget">Token budget</label>
          <input type="number" id="tokenBudget" placeholder="auto"
                 title="Max tokens per batch request. Leave blank for auto‑calibration.">
          <small class="help">Max tokens per request. Leave blank for auto; 1000–5000 common.</small>
          <div style="display:flex;justify-content:space-between;align-items:center;margin-top:0.5rem">
            <div id="calibrationStatus" style="font-size:0.75rem"></div>
            <button id="resetCalibration" class="secondary btn-frame" style="font-size:0.75rem;padding:2px 6px">Reset</button>
          </div>
        </div>
      </details>

      <details id="cacheSection" class="panel-frame">
      <summary>Cache &amp; Debug</summary>
        <div class="form-group" style="padding-top: 0.75rem">
          <label for="memCacheMax">Memory cache max</label>
          <input type="number" id="memCacheMax" placeholder="5000"
                 title="Maximum entries for in‑memory translation cache.">
          <small class="help">Entries kept in RAM; 1000–10000 typical.</small>
          <div id="cacheStats" style="font-size:0.75rem"></div>
          <div id="tmStats" style="font-size:0.75rem"></div>

          <label title="Enable detailed logs for troubleshooting in DevTools."><input type="checkbox" id="debug"> Debug logging</label>
          <small class="help">Logs extra info to DevTools; slight performance hit.</small>
        </div>
      </details>

      <details id="glossarySection" class="panel-frame">
        <summary>Glossary</summary>
        <div class="form-group" style="padding-top: 0.75rem">
          <label for="importGlossary">Import glossary (JSON)</label>
          <input type="file" id="importGlossary" accept="application/json">
          <button id="exportGlossary" class="secondary btn-frame">Export Glossary</button>
        </div>
      </details>

      <button id="test" class="secondary btn-frame">Test Settings</button>
      <progress id="progress" value="0" max="1" style="width:100%;display:none"></progress>
      <div id="status"></div>
      <div id="version"></div>
    </div>
  </div>

  <script src="throttle.js"></script>
  <script src="lib/providers.js"></script>
  <script src="providers/openai.js"></script>
  <script src="providers/openrouter.js"></script>
  <script src="providers/deepl.js"></script>
  <script src="providers/dashscope.js"></script>
  <script src="providers/macos.js"></script>
  <script src="providers/ollama.js"></script>
  <script src="lib/messaging.js"></script>
  <script src="lib/glossary.js"></script>
  <script src="translator.js"></script>
  <script src="config.js"></script>
  <script src="languages.js"></script>
  <script src="usageColor.js"></script>
  <script src="popup.js"></script>
  <script src="popup/support.js"></script>
</body>
</html>
