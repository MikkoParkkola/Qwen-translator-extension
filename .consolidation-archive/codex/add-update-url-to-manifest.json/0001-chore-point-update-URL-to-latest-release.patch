From c7257aefb5d1416e518fbc548e7e68cd1f1b43b5 Mon Sep 17 00:00:00 2001
From: MikkoParkkola <78788115+MikkoParkkola@users.noreply.github.com>
Date: Sun, 17 Aug 2025 17:05:19 +0200
Subject: [PATCH] chore: point update URL to latest release

---
 .github/workflows/publish.yml | 19 +++++++++++++++----
 src/background.js             | 13 +++++++++++++
 src/manifest.json             | 25 +++++++++++++++----------
 3 files changed, 43 insertions(+), 14 deletions(-)

diff --git a/.github/workflows/publish.yml b/.github/workflows/publish.yml
index a9c23f0..70dd2f7 100644
--- a/.github/workflows/publish.yml
+++ b/.github/workflows/publish.yml
@@ -20,28 +20,39 @@ jobs:
           cache: npm
       - run: npm ci
       - run: npm run build
-      - run: npm run build:zip
+      - name: Get version
+        id: vars
+        run: echo "VERSION=$(jq -r .version src/manifest.json)" >> $GITHUB_OUTPUT
+      - name: Pack CRX
+        run: |
+          echo "${{ secrets.EXTENSION_KEY }}" > extension.pem
+          npx --yes crx3 -p extension.pem -o dist/qwen-translator-${{ steps.vars.outputs.VERSION }}.crx dist
+          rm extension.pem
+      - run: npm run zip
       - name: Prepare release assets
         id: prep
         run: |
-          VERSION=$(jq -r .version src/manifest.json)
-          ZIP_NAME="qwen-translator-${VERSION}.zip"
+          VERSION=${{ steps.vars.outputs.VERSION }}
+          CRX_NAME="qwen-translator-${VERSION}.crx"
+          ZIP_NAME="qwen-translator-v${VERSION}.zip"
           mv dist/*.zip "dist/${ZIP_NAME}"
           cat <<XML > dist/updates.xml
 <?xml version="1.0" encoding="UTF-8"?>
 <gupdate xmlns="http://www.google.com/update2/response" protocol="2.0">
   <app appid="${EXTENSION_ID}">
-    <updatecheck codebase="https://github.com/${GITHUB_REPOSITORY}/releases/download/v${VERSION}/${ZIP_NAME}" version="${VERSION}" />
+    <updatecheck codebase="https://github.com/${GITHUB_REPOSITORY}/releases/download/v${VERSION}/${CRX_NAME}" version="${VERSION}" />
   </app>
 </gupdate>
 XML
           echo "VERSION=$VERSION" >> "$GITHUB_OUTPUT"
+          echo "CRX_NAME=$CRX_NAME" >> "$GITHUB_OUTPUT"
           echo "ZIP_NAME=$ZIP_NAME" >> "$GITHUB_OUTPUT"
       - name: Create release
         uses: softprops/action-gh-release@v1
         with:
           tag_name: v${{ steps.prep.outputs.VERSION }}
           files: |
+            dist/${{ steps.prep.outputs.CRX_NAME }}
             dist/${{ steps.prep.outputs.ZIP_NAME }}
             dist/updates.xml
 
diff --git a/src/background.js b/src/background.js
index 2449fd7..1f5713d 100644
--- a/src/background.js
+++ b/src/background.js
@@ -6,6 +6,19 @@ const logger = (self.qwenLogger && self.qwenLogger.create)
 
 const panelPorts = new Set();
 
+const UPDATE_CHECK_INTERVAL = 6 * 60 * 60 * 1000;
+let pendingVersion;
+try { chrome.runtime.requestUpdateCheck?.(() => {}); } catch {}
+setInterval(() => {
+  try { chrome.runtime.requestUpdateCheck?.(() => {}); } catch {}
+}, UPDATE_CHECK_INTERVAL);
+if (chrome.runtime?.onUpdateAvailable?.addListener) {
+  chrome.runtime.onUpdateAvailable.addListener(details => {
+    pendingVersion = details.version;
+    try { chrome.runtime.reload(); } catch {}
+  });
+}
+
 chrome.commands?.onCommand.addListener(async command => {
   const [tab] = await chrome.tabs.query({ active: true, currentWindow: true });
   if (!tab?.id) return;
diff --git a/src/manifest.json b/src/manifest.json
index fc4526a..98c7c82 100644
--- a/src/manifest.json
+++ b/src/manifest.json
@@ -2,8 +2,9 @@
   "manifest_version": 3,
   "name": "Qwen Translator",
   "description": "Translate pages using Qwen-MT-Turbo",
-  "version": "1.21.0",
-  "version_name": "2025-08-19",
+  "version": "1.22.1",
+  "version_name": "2025-08-21",
+  "update_url": "https://github.com/MikkoParkkola/Qwen-translator-extension/releases/latest/download/updates.xml",
   "permissions": [
     "storage",
     "activeTab",
@@ -22,7 +23,7 @@
     "service_worker": "background.js"
   },
   "content_security_policy": {
-    "extension_pages": "script-src 'self' https://cdn.jsdelivr.net 'wasm-unsafe-eval'; object-src 'none'; base-uri 'none'; frame-ancestors 'self'; connect-src 'self' https: file: blob: data:; img-src 'self' https: file: blob: data:; font-src 'self';"
+    "extension_pages": "script-src 'self' 'wasm-unsafe-eval'; object-src 'none'; base-uri 'none'; frame-ancestors 'self'; connect-src 'self' https: file: blob: data:; img-src 'self' https: file: blob: data:; font-src 'self';"
   },
   "action": {
     "default_popup": "popup.html",
@@ -33,11 +34,15 @@
   },
   "commands": {
     "translate-selection": {
-      "suggested_key": { "default": "Ctrl+Shift+T" },
+      "suggested_key": {
+        "default": "Ctrl+Shift+T"
+      },
       "description": "Translate selected text"
     },
     "open-panel": {
-      "suggested_key": { "default": "Ctrl+Shift+O" },
+      "suggested_key": {
+        "default": "Ctrl+Shift+O"
+      },
       "description": "Open translation panel"
     }
   },
@@ -72,13 +77,13 @@
         "wasm/vendor/*",
         "wasm/vendor/fonts/*",
         "config.local.js",
-          "qa/compare.html",
-          "qa/usage.html",
-          "i18n/*"
-        ],
+        "qa/compare.html",
+        "qa/usage.html",
+        "i18n/*"
+      ],
       "matches": [
         "<all_urls>"
       ]
     }
   ]
-}
\ No newline at end of file
+}
-- 
2.50.0

