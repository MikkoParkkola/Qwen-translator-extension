From 48ff2be953540e0cd57432e3a92dc2a6f7b2ad21 Mon Sep 17 00:00:00 2001
From: MikkoParkkola <78788115+MikkoParkkola@users.noreply.github.com>
Date: Mon, 18 Aug 2025 07:13:31 +0200
Subject: [PATCH 9/9] Merge branch 'main' into
 codex/add-offline-indicators-and-messaging

---
 package-lock.json    |  8 ++++++++
 package.json         | 10 ++++++++++
 src/contentScript.js | 13 +++++++++++++
 3 files changed, 31 insertions(+)

diff --git a/package-lock.json b/package-lock.json
index 9ae6f69..9c58107 100644
--- a/package-lock.json
+++ b/package-lock.json
@@ -1,6 +1,7 @@
 {
   "name": "qwen-translator-extension",
 <<<<<<< HEAD
+<<<<<<< HEAD
 <<<<<<< HEAD
   "version": "1.35.1",
   "version": "1.35.1",
@@ -10,12 +11,16 @@
 =======
   "version": "1.33.0",
 >>>>>>> 76757db (Handle offline translation errors)
+=======
+  "version": "1.34.0",
+>>>>>>> 2530dd6 (Merge branch 'main' into codex/add-offline-indicators-and-messaging)
   "lockfileVersion": 3,
   "requires": true,
   "packages": {
     "": {
       "name": "qwen-translator-extension",
 <<<<<<< HEAD
+<<<<<<< HEAD
 <<<<<<< HEAD
       "version": "1.35.1",
       "version": "1.35.1",
@@ -25,6 +30,9 @@
 =======
       "version": "1.33.0",
 >>>>>>> 76757db (Handle offline translation errors)
+=======
+      "version": "1.34.0",
+>>>>>>> 2530dd6 (Merge branch 'main' into codex/add-offline-indicators-and-messaging)
       "hasInstallScript": true,
       "license": "AGPL-3.0-or-later",
       "dependencies": {
diff --git a/package.json b/package.json
index d575c8f..9d4153d 100644
--- a/package.json
+++ b/package.json
@@ -1,6 +1,7 @@
 {
   "name": "qwen-translator-extension",
 <<<<<<< HEAD
+<<<<<<< HEAD
 <<<<<<< HEAD
   "version": "1.35.1",
 =======
@@ -9,6 +10,9 @@
 =======
   "version": "1.33.0",
 >>>>>>> 76757db (Handle offline translation errors)
+=======
+  "version": "1.35.0",
+>>>>>>> 2530dd6 (Merge branch 'main' into codex/add-offline-indicators-and-messaging)
   "description": "Extension to translate web pages using Qwen-MT-Turbo model",
   "main": "index.js",
   "scripts": {
@@ -32,6 +36,7 @@
   "license": "AGPL-3.0-or-later",
   "type": "commonjs",
   "types": "types/index.d.ts",
+<<<<<<< HEAD
 <<<<<<< HEAD
   "typesVersions": {
     "*": {
@@ -50,6 +55,8 @@
     }
   },
 =======
+=======
+>>>>>>> 2530dd6 (Merge branch 'main' into codex/add-offline-indicators-and-messaging)
     "typesVersions": {
       "*": {
         "background": ["types/background.d.ts"],
@@ -58,7 +65,10 @@
       "popup/*": ["types/popup/*"]
       }
     },
+<<<<<<< HEAD
 >>>>>>> bf0b100 (Merge branch 'main' into codex/add-offline-indicators-and-messaging-hvff51)
+=======
+>>>>>>> 2530dd6 (Merge branch 'main' into codex/add-offline-indicators-and-messaging)
   "devDependencies": {
     "@playwright/test": "^1.54.2",
     "@types/jest": "^30.0.0",
diff --git a/src/contentScript.js b/src/contentScript.js
index 9d4e2ba..3c07d88 100644
--- a/src/contentScript.js
+++ b/src/contentScript.js
@@ -80,6 +80,19 @@ if (typeof window !== 'undefined' && window.__qwenCSLoaded) {
   }
   window.addEventListener('beforeunload', onBeforeUnload);
 
+  function cleanupControllers() {
+    controllers.forEach(c => {
+      try { c.abort(); } catch {}
+    });
+    controllers.clear();
+  }
+
+  function onBeforeUnload() {
+    cleanupControllers();
+    window.removeEventListener('beforeunload', onBeforeUnload);
+  }
+  window.addEventListener('beforeunload', onBeforeUnload);
+
 function handleLastError(cb) {
   return (...args) => {
     const err = chrome.runtime.lastError;
-- 
2.50.0

