From 4469d4c8ff87bbb73d48218d3cab19be0d57a9e1 Mon Sep 17 00:00:00 2001
From: MikkoParkkola <78788115+MikkoParkkola@users.noreply.github.com>
Date: Tue, 19 Aug 2025 16:11:16 +0200
Subject: [PATCH 1/2] chore: split PDF e2e tests into conditional job

---
 .github/workflows/ci.yml  | 57 ++++++++++++++++++++++++++++++++++++---
 .github/workflows/e2e.yml |  5 ++--
 2 files changed, 57 insertions(+), 5 deletions(-)

diff --git a/.github/workflows/ci.yml b/.github/workflows/ci.yml
index 37142a6..7404d71 100644
--- a/.github/workflows/ci.yml
+++ b/.github/workflows/ci.yml
@@ -54,7 +54,21 @@ jobs:
           name: qwen-translator-zip
           path: dist/*.zip
 
-  e2e-smoke:
+  changes:
+    runs-on: ubuntu-latest
+    outputs:
+      pdf: ${{ steps.filter.outputs.pdf }}
+    steps:
+      - uses: dorny/paths-filter@v2
+        id: filter
+        with:
+          filters: |
+            pdf:
+              - 'src/pdf**'
+              - 'e2e/pdfs/**'
+              - 'e2e/pdf-compare.spec.js'
+
+  e2e-web:
     needs: build-and-test
     runs-on: ubuntu-latest
     steps:
@@ -86,6 +100,43 @@ jobs:
       - name: Run e2e web smoke
         run: npm run test:e2e:web
 
+      - name: Upload Playwright report
+        if: always()
+        uses: actions/upload-artifact@v4
+        with:
+          name: playwright-report-web
+          path: playwright-report
+
+  e2e-pdf:
+    needs: [build-and-test, changes]
+    if: needs.changes.outputs.pdf == 'true' || (github.event_name == 'pull_request' && contains(github.event.pull_request.labels.*.name, 'run-pdf-tests'))
+    runs-on: ubuntu-latest
+    steps:
+      - name: Checkout
+        uses: actions/checkout@v4
+
+      - name: Setup Node
+        uses: actions/setup-node@v4
+        with:
+          node-version: '20'
+          cache: 'npm'
+
+      - name: Install dependencies
+        run: npm ci
+
+      - name: Build dist
+        run: npm run build
+
+      - name: Install Playwright (Chromium + deps)
+        run: npx playwright install --with-deps chromium
+
+      - name: Start static server
+        run: |
+          nohup npx http-server . -p 8080 &
+          for i in {1..60}; do
+            curl -sSf http://127.0.0.1:8080 >/dev/null && break || sleep 1;
+          done
+
       - name: Run e2e PDF compare
         run: npm run test:e2e:pdf
 
@@ -93,11 +144,11 @@ jobs:
         if: always()
         uses: actions/upload-artifact@v4
         with:
-          name: playwright-report
+          name: playwright-report-pdf
           path: playwright-report
 
   automerge:
-    needs: [build-and-test, e2e-smoke]
+    needs: [build-and-test, e2e-web, e2e-pdf]
     if: github.event_name == 'pull_request'
     runs-on: ubuntu-latest
     permissions:
diff --git a/.github/workflows/e2e.yml b/.github/workflows/e2e.yml
index 2659a4b..753d5e6 100644
--- a/.github/workflows/e2e.yml
+++ b/.github/workflows/e2e.yml
@@ -4,8 +4,9 @@ on:
   workflow_dispatch:
   push:
     paths:
-      - 'src/**'
-      - 'e2e/**'
+      - 'src/pdf**'
+      - 'e2e/pdfs/**'
+      - 'e2e/pdf-compare.spec.js'
       - '.github/workflows/e2e.yml'
       - 'package.json'
 
-- 
2.50.0

