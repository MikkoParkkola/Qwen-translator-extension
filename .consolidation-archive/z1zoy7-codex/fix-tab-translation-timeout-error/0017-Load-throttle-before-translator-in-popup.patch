From 57eb7bc0335ae46abc80219dd29895fce0d0baca Mon Sep 17 00:00:00 2001
From: MikkoParkkola <78788115+MikkoParkkola@users.noreply.github.com>
Date: Wed, 30 Jul 2025 18:54:32 +0200
Subject: [PATCH 17/34] Load throttle before translator in popup

---
 src/manifest.json |  4 ++--
 src/popup.html    |  1 +
 src/translator.js | 14 +++++++++++++-
 3 files changed, 16 insertions(+), 3 deletions(-)

diff --git a/src/manifest.json b/src/manifest.json
index a5103e8..2742273 100644
--- a/src/manifest.json
+++ b/src/manifest.json
@@ -16,14 +16,14 @@
   },
   "web_accessible_resources": [
     {
-      "resources": ["translator.js", "config.js", "languages.js"],
+      "resources": ["translator.js", "config.js", "languages.js", "throttle.js"],
       "matches": ["<all_urls>"]
     }
   ],
   "content_scripts": [
     {
       "matches": ["<all_urls>"],
-      "js": ["config.js", "translator.js", "contentScript.js"],
+      "js": ["config.js", "throttle.js", "translator.js", "contentScript.js"],
       "run_at": "document_idle"
     }
   ]
diff --git a/src/popup.html b/src/popup.html
index 50deca2..20883f7 100644
--- a/src/popup.html
+++ b/src/popup.html
@@ -23,6 +23,7 @@
   <button id="save">Save</button>
   <button id="test">Test Settings</button>
   <div id="status"></div>
+  <script src="throttle.js"></script>
   <script src="translator.js"></script>
   <script src="config.js"></script>
   <script src="languages.js"></script>
diff --git a/src/translator.js b/src/translator.js
index d30e913..cd99c15 100644
--- a/src/translator.js
+++ b/src/translator.js
@@ -1,8 +1,20 @@
 let fetchFn = typeof fetch !== 'undefined' ? fetch : undefined;
+var runWithRateLimit;
+var approxTokens;
+
 if (typeof window === 'undefined') {
   fetchFn = require('cross-fetch');
+  ({ runWithRateLimit, approxTokens } = require('./throttle'));
+} else {
+  if (window.qwenThrottle) {
+    ({ runWithRateLimit, approxTokens } = window.qwenThrottle);
+  } else if (typeof require !== 'undefined') {
+    ({ runWithRateLimit, approxTokens } = require('./throttle'));
+  } else {
+    runWithRateLimit = fn => fn();
+    approxTokens = () => 0;
+  }
 }
-const { runWithRateLimit, approxTokens } = require('./throttle');
 
 const cache = new Map();
 
-- 
2.50.0

