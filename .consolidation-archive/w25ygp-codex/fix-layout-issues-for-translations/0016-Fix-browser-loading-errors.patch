From 9a3ef256e496bbfa45a82524017d07c0756f7f93 Mon Sep 17 00:00:00 2001
From: MikkoParkkola <78788115+MikkoParkkola@users.noreply.github.com>
Date: Wed, 30 Jul 2025 18:47:14 +0200
Subject: [PATCH 16/51] Fix browser loading errors

---
 src/manifest.json |  4 ++--
 src/translator.js | 13 ++++++++++++-
 2 files changed, 14 insertions(+), 3 deletions(-)

diff --git a/src/manifest.json b/src/manifest.json
index a5103e8..2742273 100644
--- a/src/manifest.json
+++ b/src/manifest.json
@@ -16,14 +16,14 @@
   },
   "web_accessible_resources": [
     {
-      "resources": ["translator.js", "config.js", "languages.js"],
+      "resources": ["translator.js", "config.js", "languages.js", "throttle.js"],
       "matches": ["<all_urls>"]
     }
   ],
   "content_scripts": [
     {
       "matches": ["<all_urls>"],
-      "js": ["config.js", "translator.js", "contentScript.js"],
+      "js": ["config.js", "throttle.js", "translator.js", "contentScript.js"],
       "run_at": "document_idle"
     }
   ]
diff --git a/src/translator.js b/src/translator.js
index d30e913..c0f9ea0 100644
--- a/src/translator.js
+++ b/src/translator.js
@@ -1,8 +1,19 @@
 let fetchFn = typeof fetch !== 'undefined' ? fetch : undefined;
+let runWithRateLimit;
+let approxTokens;
+
 if (typeof window === 'undefined') {
   fetchFn = require('cross-fetch');
+  ({ runWithRateLimit, approxTokens } = require('./throttle'));
+} else {
+  if (window.qwenThrottle) {
+    ({ runWithRateLimit, approxTokens } = window.qwenThrottle);
+  } else if (typeof require !== 'undefined') {
+    ({ runWithRateLimit, approxTokens } = require('./throttle'));
+  } else {
+    throw new Error('Throttle module not available');
+  }
 }
-const { runWithRateLimit, approxTokens } = require('./throttle');
 
 const cache = new Map();
 
-- 
2.50.0

