From 4db1400c40e94ad02384cc257e98265e54ce69f0 Mon Sep 17 00:00:00 2001
From: MikkoParkkola <78788115+MikkoParkkola@users.noreply.github.com>
Date: Wed, 30 Jul 2025 17:00:42 +0200
Subject: [PATCH 10/46] Fix model fetch when endpoint already includes models

---
 src/options.js | 20 ++++++++++++++------
 1 file changed, 14 insertions(+), 6 deletions(-)

diff --git a/src/options.js b/src/options.js
index 1b23ed1..b42eef0 100644
--- a/src/options.js
+++ b/src/options.js
@@ -35,7 +35,8 @@ async function fetchModels() {
   const endpoint = withSlash(endpointInput.value.trim());
   const key = apiKeyInput.value.trim();
   try {
-    const url = `${endpoint}models`;
+    // if the endpoint already points to the models path do not append again
+    const url = endpoint.endsWith('models/') ? endpoint : `${endpoint}models`;
     console.log('Fetching models from', url);
     const res = await fetch(url, {
       headers: { 'Authorization': `Bearer ${key}` }
@@ -46,13 +47,20 @@ async function fetchModels() {
     }
     const data = await res.json();
     modelSelect.innerHTML = '';
-    const list = Array.isArray(data.models) ? data.models : data;
+    const list = Array.isArray(data.models)
+      ? data.models
+      : Array.isArray(data.data)
+        ? data.data
+        : Array.isArray(data)
+          ? data
+          : [];
     list
-      .filter(m => m.model && m.model.includes('qwen-mt'))
-      .forEach(m => {
+      .map(m => (typeof m === 'string' ? m : m.model || m.id))
+      .filter(n => typeof n === 'string' && n.includes('qwen-mt'))
+      .forEach(name => {
         const opt = document.createElement('option');
-        opt.value = m.model;
-        opt.textContent = m.model;
+        opt.value = name;
+        opt.textContent = name;
         modelSelect.appendChild(opt);
       });
     attachSearch(modelSelect, modelSearch);
-- 
2.50.0

